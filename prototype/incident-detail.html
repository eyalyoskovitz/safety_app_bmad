<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×¨×˜×™ ××™×¨×•×¢ - Safety First</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <a href="admin-dashboard.html" class="back-link">â† ×—×–×¨×” ×œ×¨×©×™××”</a>
            <h1>×¤×¨×˜×™ ××™×¨×•×¢</h1>
        </header>

        <main class="detail-container">
            <div id="incidentDetail">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div id="actionButtons" class="action-buttons">
                <!-- Populated by JavaScript based on role -->
            </div>
        </main>

        <!-- Assign Modal (for Safety Officer) -->
        <div id="assignModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>×”×§×¦×” ××™×¨×•×¢ ×œ××—×¨××™</h2>
                <form id="assignForm">
                    <div class="form-section">
                        <label for="assigneeName" class="form-label">×©× ×”××—×¨××™ *</label>
                        <input
                            type="text"
                            id="assigneeName"
                            class="form-input"
                            placeholder="×œ×“×•×’××”: ×“× ×” ×œ×•×™"
                            required
                        >
                        <p class="form-hint">×¨×©×•× ××ª ×©× ×”×× ×”×œ ×©××—×¨××™ ×œ×˜×™×¤×•×œ ×‘××™×¨×•×¢ ×–×”</p>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">×”×§×¦×”</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAssignModal()">×‘×™×˜×•×œ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resolve Modal (for Manager) -->
        <div id="resolveModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>×¡×’×™×¨×ª ××™×¨×•×¢</h2>
                <form id="resolveForm">
                    <div class="form-section">
                        <label for="resolutionNotes" class="form-label">×”×¢×¨×•×ª ×¡×’×™×¨×” *</label>
                        <textarea
                            id="resolutionNotes"
                            class="form-textarea"
                            rows="4"
                            placeholder="×ª××¨ ××” × ×¢×©×” ×œ×˜×™×¤×•×œ ×‘××™×¨×•×¢..."
                            required
                        ></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">×¡×’×•×¨ ××™×¨×•×¢</button>
                        <button type="button" class="btn btn-secondary" onclick="closeResolveModal()">×‘×™×˜×•×œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Check authentication
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        if (!isLoggedIn) {
            window.location.href = 'admin-login.html';
        }

        const userRole = sessionStorage.getItem('userRole');
        const userName = sessionStorage.getItem('userName');
        const incidentId = sessionStorage.getItem('currentIncidentId');

        if (!incidentId) {
            window.location.href = 'admin-dashboard.html';
        }

        // Get incident
        let incident = findIncidentById(incidentId);

        if (!incident) {
            alert('××™×¨×•×¢ ×œ× × ××¦×');
            window.location.href = 'admin-dashboard.html';
        }

        // Render incident details
        function renderIncident() {
            const detailContainer = document.getElementById('incidentDetail');

            detailContainer.innerHTML = `
                <div class="detail-card">
                    <!-- Status Badge -->
                    <div class="detail-header">
                        <div class="status-chip status-${incident.status}">${getStatusLabel(incident.status)}</div>
                        <div class="severity-badge severity-${incident.severity} large">
                            ${getSeverityIcon(incident.severity)} ${getSeverityLabel(incident.severity)}
                        </div>
                    </div>

                    <!-- Photo -->
                    ${incident.photoUrl ? `
                        <div class="detail-photo">
                            <img src="${incident.photoUrl}" alt="×ª××•× ×ª ××™×¨×•×¢">
                        </div>
                    ` : ''}

                    <!-- Description -->
                    <div class="detail-section">
                        <h3>×ª×™××•×¨ ×”××™×¨×•×¢</h3>
                        <p class="detail-text">${incident.description}</p>
                    </div>

                    <!-- Metadata -->
                    <div class="detail-section">
                        <h3>×¤×¨×˜×™×</h3>
                        <div class="detail-meta-grid">
                            <div class="meta-item">
                                <span class="meta-label">ğŸ“ ××™×§×•×:</span>
                                <span class="meta-value">${getLocationLabel(incident.location)}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ• ×ª××¨×™×š:</span>
                                <span class="meta-value">${formatDate(incident.incidentDate || incident.createdAt)}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ğŸ‘¤ ××“×•×•×—:</span>
                                <span class="meta-value">${incident.reporterName || 'ğŸ”’ ×× ×•× ×™××™'}</span>
                            </div>
                            ${incident.assignedTo ? `
                                <div class="meta-item">
                                    <span class="meta-label">âœ“ ×”×•×§×¦×” ×œ:</span>
                                    <span class="meta-value">${incident.assignedTo}</span>
                                </div>
                            ` : ''}
                            ${incident.resolutionNotes ? `
                                <div class="meta-item full-width">
                                    <span class="meta-label">ğŸ“ ×”×¢×¨×•×ª ×¡×’×™×¨×”:</span>
                                    <span class="meta-value">${incident.resolutionNotes}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            renderActionButtons();
        }

        // Render action buttons based on role and status
        function renderActionButtons() {
            const actionContainer = document.getElementById('actionButtons');
            let buttons = '';

            if (userRole === 'safety_officer') {
                // Safety officer can assign incidents
                if (incident.status === 'new') {
                    buttons += `<button class="btn btn-primary btn-large" onclick="openAssignModal()">×”×§×¦×” ×œ××—×¨××™</button>`;
                }
                if (incident.status === 'assigned') {
                    buttons += `<button class="btn btn-secondary" onclick="openAssignModal()">×©× ×” ×”×§×¦××”</button>`;
                }
            } else if (userRole === 'manager') {
                // Manager can resolve only if assigned to them and not already resolved
                if (incident.assignedTo && incident.assignedTo.toLowerCase() === userName.toLowerCase() && incident.status !== 'resolved') {
                    buttons += `<button class="btn btn-primary btn-large" onclick="openResolveModal()">×¡××Ÿ ×›×˜×•×¤×œ</button>`;
                }
            }

            actionContainer.innerHTML = buttons;
        }

        // Modal functions
        function openAssignModal() {
            document.getElementById('assignModal').style.display = 'flex';
        }

        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
        }

        function openResolveModal() {
            document.getElementById('resolveModal').style.display = 'flex';
        }

        function closeResolveModal() {
            document.getElementById('resolveModal').style.display = 'none';
        }

        // Handle assignment
        document.getElementById('assignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const assigneeName = document.getElementById('assigneeName').value;

            incident.assignedTo = assigneeName;
            incident.status = 'assigned';
            incident.assignedAt = new Date().toISOString();

            updateIncident(incident);
            closeAssignModal();

            alert('×”××™×¨×•×¢ ×”×•×§×¦×” ×‘×”×¦×œ×—×” ×œ-' + assigneeName);
            renderIncident();
        });

        // Handle resolution
        document.getElementById('resolveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const notes = document.getElementById('resolutionNotes').value;

            incident.resolutionNotes = notes;
            incident.status = 'resolved';
            incident.resolvedAt = new Date().toISOString();

            updateIncident(incident);
            closeResolveModal();

            alert('×”××™×¨×•×¢ × ×¡×’×¨ ×‘×”×¦×œ×—×”');
            renderIncident();
        });

        // Helper functions
        function getStatusLabel(status) {
            const labels = {
                'new': '×—×“×©',
                'assigned': '×”×•×§×¦×”',
                'resolved': '×˜×•×¤×œ'
            };
            return labels[status] || status;
        }

        function getSeverityIcon(severity) {
            const icons = {
                'unknown': 'â“',
                'near_miss': 'âš ï¸',
                'minor': 'ğŸŸ¡',
                'major': 'ğŸŸ ',
                'critical': 'ğŸ”´'
            };
            return icons[severity] || 'â“';
        }

        function getSeverityLabel(severity) {
            const labels = {
                'unknown': '×œ× ×™×“×•×¢',
                'near_miss': '×›××¢×˜ ××™×¨×•×¢',
                'minor': '×§×œ',
                'major': '×‘×™× ×•× ×™',
                'critical': '×§×¨×™×˜×™'
            };
            return labels[severity] || severity;
        }

        function getLocationLabel(location) {
            const labels = {
                'production_line': '×¤×¡ ×™×™×¦×•×¨',
                'loading_dock': '×¨×¦×™×£ ×˜×¢×™× ×”',
                'warehouse': '××—×¡×Ÿ',
                'parking': '×—× ×™×”',
                'cafeteria': '×—×“×¨ ××•×›×œ',
                'other': '××—×¨'
            };
            return labels[location] || location;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Initial render
        renderIncident();
    </script>
</body>
</html>
